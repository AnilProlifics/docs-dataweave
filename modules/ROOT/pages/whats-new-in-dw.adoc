= What's New in DataWeave

DataWeave 2.5 is bundled with Mule 4.5. The 2.5 version of DataWeave introduces some new features.

== Versioning Behavior in DataWeave

DataWeave enables backward compatibility with previous 2.x versions of DataWeave at the Mule application and DataWeave script levels:

* Compatibility flags are a set of DataWeave xref:dataweave-system-properties.adoc[DataWeave system properties] that enable you to retain specific DataWeave behavior at the Mule application level. The flags are valid for specified DataWeave versions and expire in a future version of DataWeave. Flags change behavior based on the value of the Mule `minMuleVersion` system property, which corresponds to a DataWeave version. See xref:feature-flagging.adoc[] for details.
//2.5 DOC MERGED: https://github.com/mulesoft/docs-dataweave/pull/214/files

* Syntax-level support for specific DataWeave versions is available at the script level through the `%dw` directive (see xref:dataweave-language-introduction.adoc#dw_header[DataWeave Scripts]). Setting the directive to an earlier version of DataWeave avoids any syntax-breaking changes when the DataWeave runtime engine runs the script. This script-level setting enables you to retain earlier behavior in some scripts while using the latest behavior in others. The syntax did not change between DataWeave versions 2.1 through 2.4.
// 2.5 DOC MERGED: https://github.com/mulesoft/docs-dataweave/pull/214/files
//TODO: VERIFY no syntax changes between 2.1-2.4.
//TODO: Need to list any and all changes to syntax in 2.5,
//      since this will be requested. Is there a tag or something in the code
//      for these changes?

For detail, see xref:dataweave-versioning-behavior.adoc[].

== Supported Formats

DataWeave supports the ProtoBuf format and extends its XML support to reading and creating doctype directives (DTDs).

* Protocol Buffers (Protobuf): This format is typically used with gRPC, the Remote Procedure Call (RPC) framework. See xref:dataweave-formats-protobuf.adoc[].

* DTD for XML: To support cXML, DataWeave can read and create doctype declarations through xref:dw-dtd.adoc[]. For security reasons, the DTDs remain disabled.
// TODO: how does this related to the new system property,
// xref:dataweave-system-properties.adoc[system property] `com.mulesoft.dw.xml_reader.parseDtd`?

== Reusing DataWeave Types

In addition to loading types from custom DataWeave modules and mappings, DataWeave now can load types defined through JSON schemas, XML schemas, and Java classes.

//TODO: VERIFY XREF AND ANCHOR IN NEW DOC
See xref:dataweave-type-system.adoc#reusing-types[Reusing Types] in the DataWeave type system documentation


== Specifying Type Parameters

See "Specify Type Parameters" in xref:dataweave-functions-lambdas.adoc[].

* Typing enhancements that allow for reuse of type definitions from other sources:
** Type parameters in a function call.  //TODO: ADD anchored link to section.
See "Type Parameters Definition" in xref:dataweave-functions.adoc[].
//TODO: ADD anchored link to section.
//From ANA: Type parameters in function calls (@Andrés Radunsky): This is a very
//          advanced scenario where typed parameters, or generics, will now be able
//          to be declared at the function call level.  So one can say
//          myFunc<String>()  to signal that the generic in myFunc<T>() should
//          be a String. In the past, generics were always inferred which led
//          to some type checking errors. Because this required a syntax change,
//          it will only be available to scripts declaring %dw 2.5  or higher
//          (in the future) as their desired version.
//github MERGE (type parameter application):
//             https://github.com/mulesoft/docs-dataweave/pull/215/files

** Creating new DataWeave types from existing types. The dot selector (`.`) enables you to navigate over DataWeave xref:dataweave-type-system.adoc#composite-types[type] definitions and define new types from existing ones. Combined with the existing xref:dataweave-selectors-reusing-types.adoc[loader] for DataWeave modules, DataWeave can also load and translate declarations from a custom module file into DataWeave type directives that can be accessed in the same way as types from any other DataWeave module.
//PR for this doc: https://github.com/mulesoft/docs-dataweave/pull/224/files

== New DataWeave Function Modules and Features

DataWeave introduces the following changes:

* xref:dw-dtd.adoc[] module (`dw::xml::Dtd`) is new and includes the following:
** xref:dw-dtd-functions-doctypeasstring.adoc[] function
** xref:dw-dtd-types.adoc[] types

* xref:dw-binaries.adoc[] update:
** xref:dw-binaries-functions-concatwith.adoc[] (new in 2.5)

* xref:dw-coercions.adoc[] update:
** xref:dw-coercions-functions-tostring.adoc[] adds the `locale` parameter.


* xref:dw-core.adoc[] updates:
** xref:dw-core-annotations.adoc[]: `@UntrustedCode&#40;&#41;` changes to `@UntrustedCode&#40;privileges: Array<String&#62;&#41;`
** xref:dw-core-functions-groupby.adoc[]

* xref:dw-dates.adoc[] updates:
** xref:dw-dataformat-types.adoc[]



* xref:dw-runtime.adoc[] update:
** xref:dw-runtime-types.adoc[]
** xref:dw-runtime-functions-version.adoc[] (new in 2.5)



* Memory management
//TODO: NOT Customer Facing, BUT should we mention that there are
//      improvements in 2.5 and where they can expect to see them?
//From ANA: Mule memory service integration: Mule is launching a
//          new memory service in 4.5 which centralized all memory
//          usage to provide a single observability point. Within the
//          context of Mule, we had to start using this service to obtain
//          memory buffers and such. We are assuming Mule will document
//          this but we might want to add a note somewhere in our docs
//          about the change when running in the context of Mule.

* Metadata assignment operator. See xref:dw-operators.adoc[].
//TODO: ADD anchored link to section.
//github MERGE: https://github.com/mulesoft/docs-dataweave/pull/211

For information about the Mule 4.5 release, refer to xref:4.5@mule-runtime::whats-new-in-mule.adoc[What's New in Mule 4.5].


///////////////
//List from Slack #data-weave-docs (https://salesforce-internal.slack.com/archives/C011SNL2469/p1670446024214799)

//Typing enhancements: These are all improvements to our typing system meant to allow the reuse of type definitions from other sources.

//JsonSchema support: Users will be able to reference their JSON schemas to define DW types.

//XmlSchema support (@Martín Cousido): Users will be able to reference their XML schemas to define DW types.

//Java support (@Christian Chibana): Users will be able to reference their Java classes to define DW types.



//Attach metadata operator <~ (@Santiago Vacas): This new operator allows to attach metadata to any value and will replace the as syntax that forced type references.


//////////////////////

//TODO NOTE on other work (but not in what's new): make sure to point to the metadataOf function for info about when  typeOf is used on a value that has metadata attached. See Slack https://salesforce-internal.slack.com/archives/C011SNL2469/p1670526310905289?thread_ts=1670526284.229539&cid=C011SNL2469

//TBD: ARE THERE ANY NEW ONES?
//== New Properties for Data Formats

//DataWeave introduces the following reader and writer properties:

//TBD: ARE THERE ANY NEW ONES?
//== New DataWeave Function Modules and Features

//New and modified DataWeave modules and features:
//List any that have changed behavior
